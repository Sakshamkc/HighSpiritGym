@model List<HighSpiritApp.Models.Customer>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    int sn = 1;

}

<h4 class="mb-3">Members</h4>

<form method="get" class="mb-3">
    <div class="d-flex flex-wrap gap-2 align-items-center">
        <div class="input-group" style="max-width:1070px;">
            <input name="search"
                   value="@ViewBag.Search"
                   class="form-control"
                   placeholder="Search by name or phone"
                   autocomplete="off"/>
            <input type="hidden" name="filter" value="@ViewBag.Filter" />
            <button class="btn btn-primary">
                <i class="fa-solid fa-search"></i>
            </button>
        </div>

        <a href="/Customers/ExportAll"
           class="btn btn-success btn-lg ms-auto">
            <i class="fa-solid fa-file-download"></i> Export Excel
        </a>
    </div>
</form>

<div class="mb-3">
    <a class="btn btn-sm @(ViewBag.Filter=="all"?"btn-primary":"btn-outline-primary")"
       href="?filter=all&search=@ViewBag.Search">All</a>

    <a class="btn btn-sm @(ViewBag.Filter=="active"?"btn-success":"btn-outline-success")"
       href="?filter=active&search=@ViewBag.Search">Active</a>

    <a class="btn btn-sm @(ViewBag.Filter=="expired"?"btn-danger":"btn-outline-danger")"
       href="?filter=expired&search=@ViewBag.Search">Expired</a>

    <a class="btn btn-sm @(ViewBag.Filter=="soon"?"btn-warning":"btn-outline-warning")"
       href="?filter=soon&search=@ViewBag.Search">Expiring in 7 Days</a>
</div>



<div class="card shadow">
    <div class="card-body p-0">
        <table class="table table-striped table-hover mb-0">
            <thead class="table-dark">
                <tr>
                    <th>S.No</th>
                    <th>Photo</th>

                    <th>
                        <a href="?sort=@(ViewBag.Sort == "name_desc" ? "" : "name_desc")&search=@ViewBag.Search"
                           class="text-white text-decoration-none">
                            Name
                        </a>
                    </th>

                    <th>Phone</th>
                    <th>Plan</th>
                    <th>Price</th>

                    <th>
                        <a href="?sort=@(ViewBag.Sort == "expire_desc" ? "expire" : "expire_desc")&search=@ViewBag.Search" &filter=@ViewBag.Filter
                           class="text-white text-decoration-none">
                            Expire
                        </a>
                    </th>
                    <th>Shift</th>
                    <th>Remarks</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var c in Model)
                {
                    var m = c.Memberships?.FirstOrDefault(x => x.IsActive);
                    <tr>
                        <td>@(sn++)</td>
                        <td>
                            @if (c.Photo != null)
                            {
                                <img src="data:image/jpeg;base64,@Convert.ToBase64String(c.Photo)"
                                     class="rounded-circle"
                                     style="width:40px;height:40px;" />
                            }
                            else
                            {
                                <i class="fa-solid fa-user-circle fa-2x text-secondary"></i>
                            }

                        </td>
                        <td>@c.FullName</td>
                        <td>@c.Phone</td>
                        <td>@m?.PlanName</td>
                        <td>@(m?.PaidPrice != null ? m.PaidPrice.ToString() : "-")</td>
                        <td>
                            @if (m?.ExpireDate != null)
                            {
                                var d = m.ExpireDate.Value;
                                string suffix =
                                d.Day % 10 == 1 && d.Day != 11 ? "st" :
                                d.Day % 10 == 2 && d.Day != 12 ? "nd" :
                                d.Day % 10 == 3 && d.Day != 13 ? "rd" : "th";

                                @($"{d.Day}{suffix} {d:MMMM yyyy}")
                            }
                            else
                            {
                                @("-")
                            }
                        </td>
                        <td>@(string.IsNullOrEmpty(c.Shift) ? "-" : c.Shift)</td>
                        <td title="@c.Remarks">
                            @(string.IsNullOrEmpty(c.Remarks)
                                ? "-"
                                : (c.Remarks.Length > 20 ? c.Remarks.Substring(0, 20) + "..." : c.Remarks))
                        </td>

                        <td>
                            @if (m != null && m.DueDaysComputed > 0)
                            {
                                <span class="badge bg-danger">Due @m.DueDaysComputed days</span>
                            }
                            else
                            {
                                <span class="badge bg-success">Active</span>
                            }
                        </td>
                        <td>
                            <a class="btn btn-sm btn-primary" href="/Customers/Details/@c.CustomerID">View</a>
                            <a class="btn btn-sm btn-secondary"
                               href="/Customers/EditAll/@c.CustomerID">
                                Edit
                            </a>
                            @if (m != null)
                            {
                                <a class="btn btn-sm btn-success"
                                   href="/Memberships/Renew/@c.CustomerID">
                                    Renew
                                </a>

                            }

                            <button class="btn btn-sm btn-danger"
                                    data-bs-toggle="modal"
                                    data-bs-target="#delModal_@c.CustomerID">
                                Delete
                            </button>

                            <div class="modal fade" id="delModal_@c.CustomerID" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5>Confirm Delete</h5>
                                        </div>
                                        <div class="modal-body">
                                            Are you sure you want to delete <b>@c.FullName</b>?
                                        </div>
                                        <div class="modal-footer">
                                            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <a class="btn btn-danger" href="/Customers/Delete/@c.CustomerID">Yes, Delete</a>
                                        </div>
                                    </div>
                                </div>
                            </div>


                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <nav class="mt-3">
            <ul class="pagination justify-content-center">
                @for (int i = 1; i <= ViewBag.TotalPages; i++)
                {
                    <li class="page-item @(i == ViewBag.Page ? "active" : "")">
                        <a class="page-link"
                           href="?page=@i&search=@ViewBag.Search&sort=@ViewBag.Sort&filter=@ViewBag.Filter">@i</a>

                    </li>
                }
            </ul>
        </nav>

    </div>
</div>
